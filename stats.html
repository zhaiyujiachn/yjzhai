<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç½‘ç«™è®¿é—®ç»Ÿè®¡ - ç¿Ÿç¾½ä½³</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>

    <!-- é…ç½®æ–‡ä»¶ -->
    <script src="js/config.js"></script>
    <!-- å¼•å…¥è‡ªå®šä¹‰è„šæœ¬ -->
    <script src="js/logger.js"></script>
    <script src="js/validator.js"></script>
    <script src="js/data-utils.js"></script>
    <script src="js/performance.js"></script>
    <script src="js/chart-utils.js"></script>
    <style>
        .stats-page {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 2rem 0;
        }
        
        .stats-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
        }
        
        .stats-header {
            text-align: center;
            color: white;
            margin-bottom: 3rem;
        }
        
        .stats-header h1 {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .stats-header .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            margin: 0 0 1rem 0;
        }
        
        .update-controls {
            margin-top: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
        }
        
        .update-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .update-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-2px);
        }
        
        .update-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .update-status {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .back-link {
            display: inline-block;
            color: white;
            text-decoration: none;
            margin-bottom: 2rem;
            padding: 0.5rem 1rem;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 25px;
            transition: all 0.3s ease;
        }
        
        .back-link:hover {
            background: rgba(255,255,255,0.1);
            border-color: rgba(255,255,255,0.6);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }
        
        .stats-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease;
        }
        
        .stats-card:hover {
            transform: translateY(-5px);
        }
        
        .stats-card h3 {
            color: white;
            margin-bottom: 1rem;
            font-size: 1.3rem;
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #fff;
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            color: rgba(255,255,255,0.8);
            font-size: 0.9rem;
        }
        
        .chart-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 2rem;
        }
        
        .chart-section h2 {
            color: white;
            margin-bottom: 1.5rem;
            text-align: center;
        }
        
        .chart-container {
            height: 400px;
            position: relative;
        }
        
        .additional-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }
        
        .additional-stats .stats-card {
            padding: 1.5rem;
        }
        
        .additional-stats .stat-number {
            font-size: 1.8rem;
        }
        
        .info-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin: 30px 0;
            text-align: center;
        }
        
        .info-section h3 {
            margin: 0 0 15px 0;
            font-size: 1.5em;
        }
        
        .info-section p {
            margin: 8px 0;
            opacity: 0.9;
        }
        
        @media (max-width: 768px) {
            .stats-header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="stats-page">
        <div class="stats-container">
            <a href="index.html" class="back-link">â† è¿”å›é¦–é¡µ</a>
            
            <div class="stats-header">
                <h1>ğŸ“Š ç½‘ç«™è®¿é—®ç»Ÿè®¡</h1>
                <p class="subtitle">ç¿Ÿç¾½ä½³çš„ä¸ªäººç½‘ç«™è®¿é—®æ•°æ®åˆ†æ</p>
                <div class="update-controls">
                    <button id="updateBtn" class="update-btn" onclick="manualUpdate()">
                        ğŸ”„ æ‰‹åŠ¨æ›´æ–°æ•°æ®
                    </button>
                    <span id="updateStatus" class="update-status"></span>
                </div>
            </div>
            
            <!-- ä¸»è¦ç»Ÿè®¡æ•°æ® -->
            <div class="stats-grid">
                <div class="stats-card">
                    <h3>ä»Šæ—¥è®¿é—®é‡</h3>
                    <div class="stat-number" id="today-visits-detail">0</div>
                    <div class="stat-label">ä»Šå¤©æ–°å¢çš„è®¿é—®æ¬¡æ•°</div>
                </div>
                
                <div class="stats-card">
                    <h3>æ˜¨æ—¥è®¿é—®é‡</h3>
                    <div class="stat-number" id="yesterday-visits-detail">0</div>
                    <div class="stat-label">æ˜¨å¤©çš„è®¿é—®æ¬¡æ•°</div>
                </div>
                
                <div class="stats-card">
                    <h3>æ€»è®¿é—®é‡</h3>
                    <div class="stat-number" id="total-visits-detail">0</div>
                    <div class="stat-label">ç½‘ç«™ç´¯è®¡è®¿é—®æ¬¡æ•°</div>
                </div>
                
                <div class="stats-card">
                    <h3>å¹³å‡æ—¥è®¿é—®é‡</h3>
                    <div class="stat-number" id="avg-visits">0</div>
                    <div class="stat-label">å»ºç«™ä»¥æ¥å¹³å‡è®¿é—®é‡</div>
                </div>
            </div>
            
            <!-- è¶‹åŠ¿å›¾ -->
            <div class="chart-section">
                <h2>å»ºç«™ä»¥æ¥å…¨éƒ¨è®¿é—®é‡è¶‹åŠ¿</h2>
                <div class="chart-container">
                    <canvas id="visitChartDetail"></canvas>
                </div>
            </div>
            
            <!-- é™„åŠ ç»Ÿè®¡ä¿¡æ¯ -->
            <div class="additional-stats">
                <div class="stats-card">
                    <h3>æœ€é«˜å•æ—¥è®¿é—®é‡</h3>
                    <div class="stat-number" id="max-daily-visits">0</div>
                    <div class="stat-label">å»ºç«™ä»¥æ¥çš„æœ€é«˜è®°å½•</div>
                </div>
                
                <div class="stats-card">
                    <h3>æœ€è¿‘7å¤©è®¿é—®é‡</h3>
                    <div class="stat-number" id="week-visits">0</div>
                    <div class="stat-label">è¿‡å»ä¸€å‘¨çš„æ€»è®¿é—®é‡</div>
                </div>
                
                <div class="stats-card">
                    <h3>æ•°æ®è®°å½•å¤©æ•°</h3>
                    <div class="stat-number" id="record-days">0</div>
                    <div class="stat-label">å·²è®°å½•çš„æœ‰æ•ˆå¤©æ•°</div>
                </div>
                
                <div class="stats-card">
                    <h3>å¢é•¿è¶‹åŠ¿</h3>
                    <div class="stat-number" id="growth-trend">--</div>
                    <div class="stat-label">ç›¸æ¯”ä¸Šå‘¨çš„å˜åŒ–</div>
                </div>
            </div>
            
            <!-- ç³»ç»Ÿä¿¡æ¯ -->
            <div class="info-section">
                <h3>ğŸ“Š ç»Ÿè®¡ç³»ç»Ÿè¯´æ˜</h3>
                <p>â€¢ æœ¬ç³»ç»ŸåŸºäº JSON æ–‡ä»¶å­˜å‚¨è®¿é—®æ•°æ®ï¼Œæ— éœ€æ•°æ®åº“</p>
                <p>â€¢ æ”¯æŒè‡ªåŠ¨å’Œæ‰‹åŠ¨æ•°æ®æ›´æ–°</p>
                <p>â€¢ æ•°æ®æ¯å°æ—¶è‡ªåŠ¨å¤‡ä»½å’Œæ›´æ–°</p>
                <p>â€¢ æä¾›è¯¦ç»†çš„è®¿é—®è¶‹åŠ¿åˆ†æå’Œå›¾è¡¨å±•ç¤º</p>
            </div>
        </div>
    </div>
    
    <script src="js/script.js"></script>
    <script>
        // æ‰‹åŠ¨æ›´æ–°æ•°æ®
        async function manualUpdate() {
            const btn = document.getElementById('updateBtn');
            const status = document.getElementById('updateStatus');
            
            try {
                // ç¦ç”¨æŒ‰é’®
                btn.disabled = true;
                btn.textContent = 'ğŸ”„ æ›´æ–°ä¸­...';
                status.textContent = 'æ­£åœ¨æ›´æ–°æ•°æ®...';
                
                // è°ƒç”¨æœåŠ¡å™¨æ›´æ–°
                const result = await DataUtils.updateServerData();
                
                if (result && result.success) {
                    status.textContent = 'âœ… æ•°æ®æ›´æ–°æˆåŠŸ';
                    
                    // é‡æ–°åŠ è½½ç»Ÿè®¡æ•°æ®å’Œå›¾è¡¨
                    await updateDetailedStats();
                    await createDetailedChart();
                    
                    setTimeout(() => {
                        status.textContent = '';
                    }, 3000);
                } else {
                    status.textContent = 'âŒ æœåŠ¡å™¨æ›´æ–°å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®';
                    setTimeout(() => {
                        status.textContent = '';
                    }, 5000);
                }
                
            } catch (error) {
                logger.error('æ‰‹åŠ¨æ›´æ–°å¤±è´¥', error);
                status.textContent = 'âŒ æ›´æ–°å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥';
                setTimeout(() => {
                    status.textContent = '';
                }, 5000);
            } finally {
                // æ¢å¤æŒ‰é’®
                btn.disabled = false;
                btn.textContent = 'ğŸ”„ æ‰‹åŠ¨æ›´æ–°æ•°æ®';
            }
        }

        // ä¸“é—¨ä¸ºç»Ÿè®¡é¡µé¢çš„å¢å¼ºåŠŸèƒ½
        document.addEventListener('DOMContentLoaded', async function() {
            await waitForDataAndInitStats();
        });

        async function waitForDataAndInitStats() {
            try {
                // ç›´æ¥ä»æœåŠ¡å™¨è·å–æ•°æ®å¹¶åˆå§‹åŒ–ç»Ÿè®¡
                await updateDetailedStats();
                await createDetailedChart();
                
                logger.log('ç»Ÿè®¡é¡µé¢åˆå§‹åŒ–å®Œæˆ');
            } catch (error) {
                logger.error('ç»Ÿè®¡é¡µé¢åˆå§‹åŒ–å¤±è´¥:', error);
                
                // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                const updateStatus = document.getElementById('updateStatus');
                if (updateStatus) {
                    updateStatus.textContent = 'æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
                    updateStatus.style.color = '#f87171';
                }
            }
        }
        
        async function updateDetailedStats() {
            try {
                logger.log('å¼€å§‹æ›´æ–°è¯¦ç»†ç»Ÿè®¡æ•°æ®');
                
                // è·å–å…¨éƒ¨å†å²æ•°æ®è¿›è¡Œç»Ÿè®¡è®¡ç®—
                const data = await PerformanceMonitor.measureAsyncTime('è·å–å†å²æ•°æ®', async () => {
                    return await DataUtils.getServerHistory();
                });
                
                // éªŒè¯æ•°æ®
                const validatedData = DataValidator.validateHistoryData(data);
                logger.log('å†å²æ•°æ®éªŒè¯å®Œæˆ:', { totalDays: Object.keys(validatedData).length });
                
                // å‡†å¤‡ç»Ÿè®¡è®¡ç®—ç”¨çš„æ•°ç»„
                const dates = Object.keys(validatedData).sort();
                const visits = dates.map(date => validatedData[date]?.daily || 0);
                
                logger.log('å†å²æ•°æ®:', { datesCount: dates.length, visitsCount: visits.length, visits: visits.slice(0, 5) });
                
                // è®¡ç®—åŸºæœ¬ç»Ÿè®¡æ•°æ®
                const today = new Date().toISOString().split('T')[0];
                const yesterday = new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                
                const todayData = validatedData[today];
                const yesterdayData = validatedData[yesterday];
                const currentTotal = todayData ? todayData.total : 0;
                
                document.getElementById('today-visits-detail').textContent = todayData ? todayData.daily : 0;
                document.getElementById('yesterday-visits-detail').textContent = yesterdayData ? yesterdayData.daily : 0;
                document.getElementById('total-visits-detail').textContent = currentTotal;
                
                // å¹³å‡è®¿é—®é‡ï¼ˆåŸºäºå…¨éƒ¨æœ‰æ•ˆæ•°æ®ï¼‰
                const validVisits = visits.filter(v => v > 0);
                const avgVisits = validVisits.length > 0 ? Math.round(validVisits.reduce((a, b) => a + b, 0) / validVisits.length) : 0;
                document.getElementById('avg-visits').textContent = avgVisits;
                
                // æœ€é«˜å•æ—¥è®¿é—®é‡ï¼ˆå…¨éƒ¨å†å²æ•°æ®ä¸­çš„æœ€é«˜å€¼ï¼‰
                const maxVisits = visits.length > 0 ? Math.max(...visits) : 0;
                document.getElementById('max-daily-visits').textContent = maxVisits > 0 ? maxVisits : 0;
                
                // æœ€è¿‘7å¤©è®¿é—®é‡
                const weekVisits = visits.slice(-7).reduce((a, b) => a + b, 0);
                document.getElementById('week-visits').textContent = weekVisits;
                
                // æ•°æ®è®°å½•å¤©æ•°
                const recordDays = dates.length;
                document.getElementById('record-days').textContent = recordDays;
                
                // å¢é•¿è¶‹åŠ¿ï¼ˆæ¯”è¾ƒæœ€è¿‘7å¤©å’Œå‰7å¤©ï¼‰
                const thisWeekVisits = visits.slice(-7).reduce((a, b) => a + b, 0);
                const lastWeekVisits = visits.slice(-14, -7).reduce((a, b) => a + b, 0);
                
                if (lastWeekVisits > 0) {
                    const growthRate = ((thisWeekVisits - lastWeekVisits) / lastWeekVisits * 100).toFixed(1);
                    const growthText = growthRate > 0 ? `+${growthRate}%` : `${growthRate}%`;
                    document.getElementById('growth-trend').textContent = growthText;
                    document.getElementById('growth-trend').style.color = growthRate > 0 ? '#4ade80' : '#f87171';
                } else {
                    document.getElementById('growth-trend').textContent = '--';
                }
                
                logger.log('ç»Ÿè®¡æ•°æ®æ›´æ–°å®Œæˆ');
            } catch (error) {
                logger.error('æ›´æ–°ç»Ÿè®¡æ•°æ®æ—¶å‡ºé”™:', error);
            }
        }
        
        async function createDetailedChart() {
            try {
                logger.log('å¼€å§‹åˆ›å»ºè¯¦ç»†å›¾è¡¨');
                
                // ä»æœåŠ¡å™¨è·å–æ•°æ®
                const data = await PerformanceMonitor.measureAsyncTime('è·å–å›¾è¡¨æ•°æ®', async () => {
                    const response = await fetch('/api/stats/history');
                    if (!response.ok) throw new Error('æœåŠ¡å™¨å“åº”é”™è¯¯');
                    return await response.json();
                });
                
                // éªŒè¯æ•°æ®
                const validatedData = DataValidator.validateHistoryData(data);
                logger.log('å›¾è¡¨æ•°æ®éªŒè¯å®Œæˆ', { 
                    totalDays: Object.keys(validatedData).length 
                });
                
                if (Object.keys(validatedData).length === 0) {
                    logger.warn('æ²¡æœ‰æ•°æ®å¯æ˜¾ç¤ºå›¾è¡¨');
                    ChartUtils.showNoDataMessage('visitChartDetail');
                    return;
                }
                
                // å‡†å¤‡å›¾è¡¨æ•°æ®
                const chartData = PerformanceMonitor.measureTime('å‡†å¤‡å›¾è¡¨æ•°æ®', () => {
                    const dates = Object.keys(validatedData).sort();
                    const visits = dates.map(date => validatedData[date]?.daily || 0);
                    const totalCounts = dates.map(date => validatedData[date]?.total || 0);
                    
                    return { dates, visits, totalCounts };
                });
                
                // åˆ›å»ºå›¾è¡¨
                window.detailChart = ChartUtils.createVisitChart(
                    'visitChartDetail',
                    chartData.dates,
                    chartData.visits,
                    chartData.totalCounts,
                    {
                        instanceName: 'detailChart',
                        title: `å»ºç«™ä»¥æ¥å…¨éƒ¨è®¿é—®é‡è¶‹åŠ¿ (${chartData.dates.length} å¤©æ•°æ®)`,
                        showTitle: true,
                        showLegend: false,
                        showAxisTitles: true
                    }
                );
                
                logger.log('è¯¦ç»†å›¾è¡¨åˆ›å»ºå®Œæˆ', {
                    dataPoints: chartData.dates.length
                });
                
            } catch (error) {
                logger.error('åˆ›å»ºè¯¦ç»†å›¾è¡¨æ—¶å‡ºé”™', error);
                ChartUtils.showNoDataMessage('visitChartDetail', 'å›¾è¡¨åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            }
        }
    </script>
</body>
</html>