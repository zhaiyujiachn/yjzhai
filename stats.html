<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>网站访问统计 - 翟羽佳</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>

    <!-- 配置文件 -->
    <script src="js/config.js"></script>
    <!-- 引入自定义脚本 -->
    <script src="js/logger.js"></script>
    <script src="js/validator.js"></script>
    <script src="js/data-utils.js"></script>
    <script src="js/performance.js"></script>
    <script src="js/chart-utils.js"></script>
    <style>
        .stats-page {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 2rem 0;
        }
        
        .stats-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
        }
        
        .stats-header {
            text-align: center;
            color: white;
            margin-bottom: 3rem;
        }
        
        .stats-header h1 {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .stats-header .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            margin: 0 0 1rem 0;
        }
        
        .update-controls {
            margin-top: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
        }
        
        .update-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .update-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-2px);
        }
        
        .update-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .update-status {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .back-link {
            display: inline-block;
            color: white;
            text-decoration: none;
            margin-bottom: 2rem;
            padding: 0.5rem 1rem;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 25px;
            transition: all 0.3s ease;
        }
        
        .back-link:hover {
            background: rgba(255,255,255,0.1);
            border-color: rgba(255,255,255,0.6);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }
        
        .stats-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease;
        }
        
        .stats-card:hover {
            transform: translateY(-5px);
        }
        
        .stats-card h3 {
            color: white;
            margin-bottom: 1rem;
            font-size: 1.3rem;
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #fff;
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            color: rgba(255,255,255,0.8);
            font-size: 0.9rem;
        }
        
        .chart-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 2rem;
        }
        
        .chart-section h2 {
            color: white;
            margin-bottom: 1.5rem;
            text-align: center;
        }
        
        .chart-container {
            height: 400px;
            position: relative;
        }
        
        .additional-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }
        
        .additional-stats .stats-card {
            padding: 1.5rem;
        }
        
        .additional-stats .stat-number {
            font-size: 1.8rem;
        }
        
        .info-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin: 30px 0;
            text-align: center;
        }
        
        .info-section h3 {
            margin: 0 0 15px 0;
            font-size: 1.5em;
        }
        
        .info-section p {
            margin: 8px 0;
            opacity: 0.9;
        }
        
        @media (max-width: 768px) {
            .stats-header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="stats-page">
        <div class="stats-container">
            <a href="index.html" class="back-link">← 返回首页</a>
            
            <div class="stats-header">
                <h1>📊 网站访问统计</h1>
                <p class="subtitle">翟羽佳的个人网站访问数据分析</p>
                <div class="update-controls">
                    <button id="updateBtn" class="update-btn" onclick="manualUpdate()">
                        🔄 手动更新数据
                    </button>
                    <span id="updateStatus" class="update-status"></span>
                </div>
            </div>
            
            <!-- 主要统计数据 -->
            <div class="stats-grid">
                <div class="stats-card">
                    <h3>今日访问量</h3>
                    <div class="stat-number" id="today-visits-detail">0</div>
                    <div class="stat-label">今天新增的访问次数</div>
                </div>
                
                <div class="stats-card">
                    <h3>昨日访问量</h3>
                    <div class="stat-number" id="yesterday-visits-detail">0</div>
                    <div class="stat-label">昨天的访问次数</div>
                </div>
                
                <div class="stats-card">
                    <h3>总访问量</h3>
                    <div class="stat-number" id="total-visits-detail">0</div>
                    <div class="stat-label">网站累计访问次数</div>
                </div>
                
                <div class="stats-card">
                    <h3>平均日访问量</h3>
                    <div class="stat-number" id="avg-visits">0</div>
                    <div class="stat-label">建站以来平均访问量</div>
                </div>
            </div>
            
            <!-- 趋势图 -->
            <div class="chart-section">
                <h2>建站以来全部访问量趋势</h2>
                <div class="chart-container">
                    <canvas id="visitChartDetail"></canvas>
                </div>
            </div>
            
            <!-- 附加统计信息 -->
            <div class="additional-stats">
                <div class="stats-card">
                    <h3>最高单日访问量</h3>
                    <div class="stat-number" id="max-daily-visits">0</div>
                    <div class="stat-label">建站以来的最高记录</div>
                </div>
                
                <div class="stats-card">
                    <h3>最近7天访问量</h3>
                    <div class="stat-number" id="week-visits">0</div>
                    <div class="stat-label">过去一周的总访问量</div>
                </div>
                
                <div class="stats-card">
                    <h3>数据记录天数</h3>
                    <div class="stat-number" id="record-days">0</div>
                    <div class="stat-label">已记录的有效天数</div>
                </div>
                
                <div class="stats-card">
                    <h3>增长趋势</h3>
                    <div class="stat-number" id="growth-trend">--</div>
                    <div class="stat-label">相比上周的变化</div>
                </div>
            </div>
            
            <!-- 系统信息 -->
            <div class="info-section">
                <h3>📊 统计系统说明</h3>
                <p>• 本系统基于 JSON 文件存储访问数据，无需数据库</p>
                <p>• 支持自动和手动数据更新</p>
                <p>• 数据每小时自动备份和更新</p>
                <p>• 提供详细的访问趋势分析和图表展示</p>
            </div>
        </div>
    </div>
    
    <script src="js/script.js"></script>
    <script>
        // 手动更新数据
        async function manualUpdate() {
            const btn = document.getElementById('updateBtn');
            const status = document.getElementById('updateStatus');
            
            try {
                // 禁用按钮
                btn.disabled = true;
                btn.textContent = '🔄 更新中...';
                status.textContent = '正在更新数据...';
                
                // 调用服务器更新
                const result = await DataUtils.updateServerData();
                
                if (result && result.success) {
                    status.textContent = '✅ 数据更新成功';
                    
                    // 重新加载统计数据和图表
                    await updateDetailedStats();
                    await createDetailedChart();
                    
                    setTimeout(() => {
                        status.textContent = '';
                    }, 3000);
                } else {
                    status.textContent = '❌ 服务器更新失败，使用本地数据';
                    setTimeout(() => {
                        status.textContent = '';
                    }, 5000);
                }
                
            } catch (error) {
                logger.error('手动更新失败', error);
                status.textContent = '❌ 更新失败，请检查网络连接';
                setTimeout(() => {
                    status.textContent = '';
                }, 5000);
            } finally {
                // 恢复按钮
                btn.disabled = false;
                btn.textContent = '🔄 手动更新数据';
            }
        }

        // 专门为统计页面的增强功能
        document.addEventListener('DOMContentLoaded', async function() {
            await waitForDataAndInitStats();
        });

        async function waitForDataAndInitStats() {
            try {
                // 直接从服务器获取数据并初始化统计
                await updateDetailedStats();
                await createDetailedChart();
                
                logger.log('统计页面初始化完成');
            } catch (error) {
                logger.error('统计页面初始化失败:', error);
                
                // 显示错误信息
                const updateStatus = document.getElementById('updateStatus');
                if (updateStatus) {
                    updateStatus.textContent = '数据加载失败，请稍后重试';
                    updateStatus.style.color = '#f87171';
                }
            }
        }
        
        async function updateDetailedStats() {
            try {
                logger.log('开始更新详细统计数据');
                
                // 获取全部历史数据进行统计计算
                const data = await PerformanceMonitor.measureAsyncTime('获取历史数据', async () => {
                    return await DataUtils.getServerHistory();
                });
                
                // 验证数据
                const validatedData = DataValidator.validateHistoryData(data);
                logger.log('历史数据验证完成:', { totalDays: Object.keys(validatedData).length });
                
                // 准备统计计算用的数组
                const dates = Object.keys(validatedData).sort();
                const visits = dates.map(date => validatedData[date]?.daily || 0);
                
                logger.log('历史数据:', { datesCount: dates.length, visitsCount: visits.length, visits: visits.slice(0, 5) });
                
                // 计算基本统计数据
                const today = new Date().toISOString().split('T')[0];
                const yesterday = new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                
                const todayData = validatedData[today];
                const yesterdayData = validatedData[yesterday];
                const currentTotal = todayData ? todayData.total : 0;
                
                document.getElementById('today-visits-detail').textContent = todayData ? todayData.daily : 0;
                document.getElementById('yesterday-visits-detail').textContent = yesterdayData ? yesterdayData.daily : 0;
                document.getElementById('total-visits-detail').textContent = currentTotal;
                
                // 平均访问量（基于全部有效数据）
                const validVisits = visits.filter(v => v > 0);
                const avgVisits = validVisits.length > 0 ? Math.round(validVisits.reduce((a, b) => a + b, 0) / validVisits.length) : 0;
                document.getElementById('avg-visits').textContent = avgVisits;
                
                // 最高单日访问量（全部历史数据中的最高值）
                const maxVisits = visits.length > 0 ? Math.max(...visits) : 0;
                document.getElementById('max-daily-visits').textContent = maxVisits > 0 ? maxVisits : 0;
                
                // 最近7天访问量
                const weekVisits = visits.slice(-7).reduce((a, b) => a + b, 0);
                document.getElementById('week-visits').textContent = weekVisits;
                
                // 数据记录天数
                const recordDays = dates.length;
                document.getElementById('record-days').textContent = recordDays;
                
                // 增长趋势（比较最近7天和前7天）
                const thisWeekVisits = visits.slice(-7).reduce((a, b) => a + b, 0);
                const lastWeekVisits = visits.slice(-14, -7).reduce((a, b) => a + b, 0);
                
                if (lastWeekVisits > 0) {
                    const growthRate = ((thisWeekVisits - lastWeekVisits) / lastWeekVisits * 100).toFixed(1);
                    const growthText = growthRate > 0 ? `+${growthRate}%` : `${growthRate}%`;
                    document.getElementById('growth-trend').textContent = growthText;
                    document.getElementById('growth-trend').style.color = growthRate > 0 ? '#4ade80' : '#f87171';
                } else {
                    document.getElementById('growth-trend').textContent = '--';
                }
                
                logger.log('统计数据更新完成');
            } catch (error) {
                logger.error('更新统计数据时出错:', error);
            }
        }
        
        async function createDetailedChart() {
            try {
                logger.log('开始创建详细图表');
                
                // 从服务器获取数据
                const data = await PerformanceMonitor.measureAsyncTime('获取图表数据', async () => {
                    const response = await fetch('/api/stats/history');
                    if (!response.ok) throw new Error('服务器响应错误');
                    return await response.json();
                });
                
                // 验证数据
                const validatedData = DataValidator.validateHistoryData(data);
                logger.log('图表数据验证完成', { 
                    totalDays: Object.keys(validatedData).length 
                });
                
                if (Object.keys(validatedData).length === 0) {
                    logger.warn('没有数据可显示图表');
                    ChartUtils.showNoDataMessage('visitChartDetail');
                    return;
                }
                
                // 准备图表数据
                const chartData = PerformanceMonitor.measureTime('准备图表数据', () => {
                    const dates = Object.keys(validatedData).sort();
                    const visits = dates.map(date => validatedData[date]?.daily || 0);
                    const totalCounts = dates.map(date => validatedData[date]?.total || 0);
                    
                    return { dates, visits, totalCounts };
                });
                
                // 创建图表
                window.detailChart = ChartUtils.createVisitChart(
                    'visitChartDetail',
                    chartData.dates,
                    chartData.visits,
                    chartData.totalCounts,
                    {
                        instanceName: 'detailChart',
                        title: `建站以来全部访问量趋势 (${chartData.dates.length} 天数据)`,
                        showTitle: true,
                        showLegend: false,
                        showAxisTitles: true
                    }
                );
                
                logger.log('详细图表创建完成', {
                    dataPoints: chartData.dates.length
                });
                
            } catch (error) {
                logger.error('创建详细图表时出错', error);
                ChartUtils.showNoDataMessage('visitChartDetail', '图表加载失败，请刷新页面重试');
            }
        }
    </script>
</body>
</html>